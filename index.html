<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon210.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSK9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Кибербаскетбол PRO</title>
    <style>
        :root {
            --primary: #4cc9f0;
            --secondary: #f72585;
            --background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            --container-bg: rgba(0, 0, 0, 0.95);
        }

        .theme-sun { --background: linear-gradient(135deg, #ff9d00, #ff2e00, #ff0099); --primary: #ff9d00; --secondary: #ff0099; }
        .theme-moon { --background: linear-gradient(135deg, #667eea, #764ba2, #6B8DD6); --primary: #667eea; --secondary: #764ba2; }
        .theme-fullmoon { --background: linear-gradient(135deg, #4facfe, #00f2fe, #00c6fb); --primary: #4facfe; --secondary: #00f2fe; }
        .theme-newmoon { --background: linear-gradient(135deg, #2c3e50, #34495e, #1a252f); --primary: #3498db; --secondary: #2c3e50; }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }

        html, body {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            background: #000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: var(--background);
            color: white;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--container-bg);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .header {
            padding: max(5px, env(safe-area-inset-top)) 8px 0;
            flex-shrink: 0;
        }

        .title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        h1 {
            color: var(--primary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .basket-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid var(--primary);
            border-radius: 50%;
            color: var(--primary);
            cursor: pointer;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 2px;
            margin-bottom: 4px;
        }

        .tab {
            flex: 1;
            padding: 5px 2px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: white;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .tab.active {
            background: var(--primary);
            color: black;
            font-weight: bold;
        }

        .mode-switcher {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 2px;
            margin-bottom: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 5px 2px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: white;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .mode-btn.active {
            background: var(--primary);
            color: black;
            font-weight: bold;
        }

        .theme-switcher {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
        }

        .theme-btn {
            padding: 5px 1px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.65rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            min-height: 26px;
        }

        .theme-btn.active {
            box-shadow: 0 0 3px var(--primary);
            background: var(--primary);
            color: black;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 0 8px 8px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-content {
            display: none;
            flex-direction: column;
            gap: 6px;
            height: 100%;
        }

        .tab-content.active {
            display: flex;
        }

        .period {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px;
            border-radius: 6px;
        }

        h2 {
            font-size: 0.85rem;
            color: var(--secondary);
            margin-bottom: 4px;
            text-align: center;
        }

        .teams-row {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .team-input {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.7rem;
            color: #bdb2ff;
            margin-bottom: 2px;
            text-align: center;
        }

        .score-input {
            width: 100%;
            padding: 6px;
            border: 2px solid var(--primary);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.95);
            font-size: 0.9rem;
            text-align: center;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        .vs-text {
            color: var(--primary);
            font-weight: bold;
            font-size: 0.75rem;
            margin: 0 1px;
        }

        .result {
            text-align: center;
            font-size: 0.9rem;
            padding: 8px;
            background: rgba(76, 201, 240, 0.2);
            border-radius: 6px;
            border: 2px solid var(--primary);
            margin-top: 3px;
        }

        .additional-result {
            text-align: center;
            font-size: 0.85rem;
            padding: 6px;
            background: rgba(247, 37, 133, 0.2);
            border-radius: 6px;
            border: 2px solid var(--secondary);
            margin-top: 3px;
        }

        .visualization-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            flex: 1;
            gap: 10px;
            padding: 5px 0;
        }

        .triangle-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto;
        }

        .triangle-svg {
            width: 100%;
            height: 100%;
        }

        .trend-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .trend-up {
            color: #4ade80;
            border: 2px solid #4ade80;
        }

        .trend-down {
            color: #f87171;
            border: 2px solid #f87171;
        }

        .trend-stable {
            color: #fbbf24;
            border: 2px solid #fbbf24;
        }

        .prediction-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prediction-panel h3 {
            color: var(--primary);
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 2px;
        }

        .prediction-method {
            padding: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 2px solid var(--secondary);
        }

        .prediction-method h4 {
            font-size: 0.75rem;
            color: var(--secondary);
            margin-bottom: 4px;
        }

        .prediction-method .result {
            font-size: 0.75rem;
            padding: 3px;
            background: transparent;
            border: none;
            margin-top: 1px;
            text-align: left;
        }

        .confidence-meter {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.98);
            padding: 6px;
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            z-index: 1000;
            border-radius: 10px 10px 0 0;
            max-height: 28vh;
            border-top: 1px solid var(--primary);
        }

        .keyboard.active {
            display: grid;
        }

        .key {
            padding: 8px 4px;
            background: var(--primary);
            border: none;
            border-radius: 4px;
            color: black;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .key.clear {
            background: #e74c3c;
        }

        .key.submit {
            background: #27ae60;
        }

        .close-keyboard {
            position: absolute;
            top: -28px;
            right: 6px;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.9rem;
            border: 1px solid var(--primary);
        }

        .period-third {
            display: none;
        }

        .risk-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 6px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-top: 4px;
        }

        .risk-low {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
        }

        .risk-medium {
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid #eab308;
        }

        .risk-high {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }

        /* Специальные стили для очень маленьких экранов */
        @media (max-height: 700px) {
            .header {
                padding: max(3px, env(safe-area-inset-top)) 6px 0;
            }
            
            .content {
                gap: 4px;
                padding: 0 6px 6px;
            }
            
            .period {
                padding: 4px;
            }
            
            .triangle-container {
                width: 150px;
                height: 150px;
            }
            
            .prediction-panel {
                padding: 8px;
                gap: 6px;
                margin-top: 6px;
            }
            
            .prediction-method {
                padding: 4px;
            }
            
            .trend-indicator {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }

        @media (max-height: 600px) {
            .triangle-container {
                width: 130px;
                height: 130px;
            }
            
            .prediction-panel h3 {
                font-size: 0.8rem;
            }
            
            .prediction-method h4 {
                font-size: 0.7rem;
            }
            
            .prediction-method .result {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body class="theme-sun">
<div class="container">
    <div class="header">
        <div class="title-row">
            <h1>🏀 Кибербаскетбол PRO</h1>
            <button class="basket-btn" onclick="clearAllData()" title="Очистить все данные">🏀</button>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="setTab('calculator')">Калькулятор</button>
            <button class="tab" onclick="setTab('visualization')">Аналитика</button>
        </div>
        <div class="mode-switcher">
            <button class="mode-btn active" onclick="setMode('two')">2 периода</button>
            <button class="mode-btn" onclick="setMode('three')">3 периода</button>
        </div>
        <div class="theme-switcher">
            <button class="theme-btn active" onclick="setTheme('sun')">☀️</button>
            <button class="theme-btn" onclick="setTheme('moon')">🌙</button>
            <button class="theme-btn" onclick="setTheme('fullmoon')">🌕</button>
            <button class="theme-btn" onclick="setTheme('newmoon')">🌑</button>
        </div>
    </div>
    <div class="content">
        <div class="tab-content active" id="calculator-tab">
            <div class="period">
                <h2>Первый период</h2>
                <div class="teams-row">
                    <div class="team-input">
                        <label>Команда 1</label>
                        <input type="text" class="score-input" id="team1-period1" value="0" readonly onclick="showKeyboard(this)">
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="team-input">
                        <label>Команда 2</label>
                        <input type="text" class="score-input" id="team2-period1" value="0" readonly onclick="showKeyboard(this)">
                    </div>
                </div>
            </div>
            <div class="period">
                <h2>Второй период</h2>
                <div class="teams-row">
                    <div class="team-input">
                        <label>Команда 1</label>
                        <input type="text" class="score-input" id="team1-period2" value="0" readonly onclick="showKeyboard(this)">
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="team-input">
                        <label>Команда 2</label>
                        <input type="text" class="score-input" id="team2-period2" value="0" readonly onclick="showKeyboard(this)">
                    </div>
                </div>
            </div>
            <div class="period period-third" id="third-period">
                <h2>Третий период</h2>
                <div class="teams-row">
                    <div class="team-input">
                        <label>Команда 1</label>
                        <input type="text" class="score-input" id="team1-period3" value="0" readonly onclick="showKeyboard(this)">
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="team-input">
                        <label>Команда 2</label>
                        <input type="text" class="score-input" id="team2-period3" value="0" readonly onclick="showKeyboard(this)">
                    </div>
                </div>
            </div>
            <div id="result" class="result" style="display:none">
                Тотал: <strong><span id="totalValue">0</span></strong>
            </div>
            <div id="additionalResult" class="additional-result" style="display:none">
                Доп. расчет: <strong><span id="additionalValue">0</span></strong>
            </div>
        </div>
        <div class="tab-content" id="visualization-tab">
            <div class="visualization-container">
                <h2>Анализ тренда тотала</h2>
                <div class="triangle-container">
                    <svg class="triangle-svg" viewBox="0 0 300 300"></svg>
                </div>
                <div id="trendIndicator" class="trend-indicator">
                    <span id="trendIcon">↔️</span>
                    <span id="trendText">Тренд не определен</span>
                </div>
                
                <div class="prediction-panel">
                    <h3>Прогноз для ставок</h3>
                    
                    <div class="prediction-method">
                        <h4>Метод 1: Экспоненциальное сглаживание</h4>
                        <div class="result">Прогноз: <span id="expSmoothPrediction">-</span></div>
                        <div class="result">Точность: <span id="expSmoothAccuracy">-</span></div>
                        <div class="confidence-meter">
                            <div id="expSmoothConfidence" class="confidence-fill" style="width:0%"></div>
                        </div>
                    </div>
                    
                    <div class="prediction-method">
                        <h4>Метод 2: Взвешенная регрессия</h4>
                        <div class="result">Прогноз: <span id="weightedRegPrediction">-</span></div>
                        <div class="result">Дов. интервал: <span id="weightedRegInterval">-</span></div>
                        <div class="confidence-meter">
                            <div id="weightedRegConfidence" class="confidence-fill" style="width:0%"></div>
                        </div>
                    </div>
                    
                    <div class="prediction-method">
                        <h4>Метод 3: Адаптивный алгоритм</h4>
                        <div class="result">Прогноз: <span id="adaptivePrediction">-</span></div>
                        <div class="result">Сигнал: <span id="adaptiveSignal">-</span></div>
                        <div class="confidence-meter">
                            <div id="adaptiveConfidence" class="confidence-fill" style="width:0%"></div>
                        </div>
                    </div>
                    
                    <div id="riskIndicator" class="risk-indicator risk-medium">
                        <span id="riskIcon">⚠️</span>
                        <span id="riskText">Умеренный риск</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="keyboard" id="keyboard">
    <button class="close-keyboard" onclick="hideKeyboard()">×</button>
    <button class="key" onclick="pressKey('1')">1</button>
    <button class="key" onclick="pressKey('2')">2</button>
    <button class="key" onclick="pressKey('3')">3</button>
    <button class="key" onclick="pressKey('4')">4</button>
    <button class="key" onclick="pressKey('5')">5</button>
    <button class="key" onclick="pressKey('6')">6</button>
    <button class="key" onclick="pressKey('7')">7</button>
    <button class="key" onclick="pressKey('8')">8</button>
    <button class="key" onclick="pressKey('9')">9</button>
    <button class="key" onclick="pressKey('0')">0</button>
    <button class="key clear" onclick="clearInput()">C</button>
    <button class="key submit" onclick="hideKeyboardWithCalculation()">✓</button>
</div>

<script>
// Глобальные переменные
let currentInput = null;
let currentMode = 'two';
let currentTab = 'calculator';

// Управление вкладками
function setTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tab}-tab`).classList.add('active');
    
    if (tab === 'visualization') {
        updateVisualization();
    }
}

// Управление режимами
function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    const thirdPeriod = document.getElementById('third-period');
    const additionalResult = document.getElementById('additionalResult');
    
    if (mode === 'three') {
        thirdPeriod.style.display = 'block';
        additionalResult.style.display = 'none';
    } else {
        thirdPeriod.style.display = 'none';
        additionalResult.style.display = 'none';
    }
    
    document.getElementById('result').style.display = 'none';
    
    if (currentTab === 'visualization') {
        updateVisualization();
    }
}

// Управление темами
function setTheme(theme) {
    document.body.className = `theme-${theme}`;
    document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    localStorage.setItem('selectedTheme', theme);
}

// Очистка данных
function clearAllData() {
    document.querySelectorAll('.score-input').forEach(input => {
        input.value = '0';
    });
    
    document.getElementById('result').style.display = 'none';
    document.getElementById('additionalResult').style.display = 'none';
    
    hideKeyboard();
    
    if (currentTab === 'visualization') {
        updateVisualization();
    }
    
    showClearNotification();
}

function showClearNotification() {
    const notification = document.createElement('div');
    notification.textContent = 'Данные очищены!';
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        border: 2px solid var(--primary);
        z-index: 1001;
        font-size: 0.9rem;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 1500);
}

// Управление клавиатурой
function showKeyboard(input) {
    currentInput = input;
    const keyboard = document.getElementById('keyboard');
    keyboard.classList.add('active');
    input.blur();
    
    setTimeout(() => {
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function hideKeyboard() {
    document.getElementById('keyboard').classList.remove('active');
    currentInput = null;
}

function hideKeyboardWithCalculation() {
    hideKeyboard();
    calculateTotal();
    if (currentTab === 'visualization') {
        updateVisualization();
    }
}

function pressKey(key) {
    if (currentInput) {
        const currentValue = currentInput.value;
        currentInput.value = currentValue === '0' ? key : currentValue + key;
    }
}

function clearInput() {
    if (currentInput) currentInput.value = '0';
}

// Обработчики событий
document.addEventListener('click', function(event) {
    const keyboard = document.getElementById('keyboard');
    const scoreInputs = document.querySelectorAll('.score-input');
    if (!keyboard.contains(event.target) && !Array.from(scoreInputs).some(input => input.contains(event.target))) {
        hideKeyboard();
    }
});

document.querySelectorAll('.score-input').forEach(input => {
    input.addEventListener('focus', function(e) {
        e.preventDefault();
        this.blur();
    });
    
    input.addEventListener('input', function() {
        if (currentTab === 'visualization') {
            updateVisualization();
        }
    });
});

// Основной расчет
function calculateTotal() {
    let total;
    let additionalTotal = null;
    
    if (currentMode === 'two') {
        const team1p1 = parseInt(document.getElementById('team1-period1').value) || 0;
        const team2p1 = parseInt(document.getElementById('team2-period1').value) || 0;
        const team1p2 = parseInt(document.getElementById('team1-period2').value) || 0;
        const team2p2 = parseInt(document.getElementById('team2-period2').value) || 0;

        const totalFirstPeriod = team1p1 + team2p1;
        const totalSecondPeriod = team1p2 + team2p2;
        
        total = (totalFirstPeriod + totalSecondPeriod) * 2;

        if (totalFirstPeriod > totalSecondPeriod) {
            total += (totalFirstPeriod - totalSecondPeriod);
        } else {
            total -= (totalSecondPeriod - totalFirstPeriod);
        }
    } else {
        const team1p1 = parseInt(document.getElementById('team1-period1').value) || 0;
        const team2p1 = parseInt(document.getElementById('team2-period1').value) || 0;
        const team1p2 = parseInt(document.getElementById('team1-period2').value) || 0;
        const team2p2 = parseInt(document.getElementById('team2-period2').value) || 0;
        const team1p3 = parseInt(document.getElementById('team1-period3').value) || 0;
        const team2p3 = parseInt(document.getElementById('team2-period3').value) || 0;

        const totalFirstPeriod = team1p1 + team2p1;
        const totalSecondPeriod = team1p2 + team2p2;
        const totalThirdPeriod = team1p3 + team2p3;
        
        total = (totalFirstPeriod + totalSecondPeriod + totalThirdPeriod) * (4/3);
        
        if (totalThirdPeriod > totalSecondPeriod) {
            total += (totalThirdPeriod - totalSecondPeriod);
        } else {
            total -= (totalSecondPeriod - totalThirdPeriod);
        }
        
        total = Math.round(total);

        // Дополнительный расчет
        const twoPeriodTotal = (totalFirstPeriod + totalSecondPeriod) * 2;
        const diffTwoPeriods = Math.abs(totalFirstPeriod - totalSecondPeriod);
        
        let adjustedTwoPeriodTotal = twoPeriodTotal;
        if (totalFirstPeriod > totalSecondPeriod) {
            adjustedTwoPeriodTotal += diffTwoPeriods;
        } else {
            adjustedTwoPeriodTotal -= diffTwoPeriods;
        }

        additionalTotal = Math.round((total + adjustedTwoPeriodTotal) / 2);
    }

    document.getElementById('totalValue').textContent = total;
    document.getElementById('result').style.display = 'block';
    
    if (currentMode === 'three' && additionalTotal !== null) {
        document.getElementById('additionalValue').textContent = additionalTotal;
        document.getElementById('additionalResult').style.display = 'block';
    } else {
        document.getElementById('additionalResult').style.display = 'none';
    }
}

// Автоматический расчет
document.querySelectorAll('.score-input').forEach(input => {
    input.addEventListener('input', function() {
        let allFilled = true;
        const requiredFields = currentMode === 'two' 
            ? ['team1-period1', 'team2-period1', 'team1-period2', 'team2-period2']
            : ['team1-period1', 'team2-period1', 'team1-period2', 'team2-period2', 'team1-period3', 'team2-period3'];
        
        for (let fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field.value || field.value === '0') {
                allFilled = false;
                break;
            }
        }
        
        if (allFilled) {
            calculateTotal();
            if (currentTab === 'visualization') {
                updateVisualization();
            }
        }
    });
});

// Алгоритмы прогнозирования
function exponentialSmoothing(data, alpha = 0.7) {
    if (data.length < 2) return { prediction: 0, accuracy: 0 };
    
    let smoothed = data[0];
    let mae = 0;
    
    for (let i = 1; i < data.length; i++) {
        const error = Math.abs(data[i] - smoothed);
        mae += error;
        smoothed = alpha * data[i] + (1 - alpha) * smoothed;
    }
    
    mae = mae / (data.length - 1);
    const accuracy = Math.max(0, 100 - (mae / (Math.max(...data) || 1)) * 100);
    
    return { prediction: Math.round(smoothed), accuracy: Math.round(accuracy) };
}

function weightedRegression(data) {
    if (data.length < 2) return { prediction: 0, interval: [0, 0], confidence: 0 };
    
    const n = data.length;
    const weights = data.map((_, i) => Math.pow(1.5, i));
    
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumW = 0;
    
    for (let i = 0; i < n; i++) {
        const x = i + 1;
        const y = data[i];
        const w = weights[i];
        
        sumX += x * w;
        sumY += y * w;
        sumXY += x * y * w;
        sumX2 += x * x * w;
        sumW += w;
    }
    
    const slope = (sumW * sumXY - sumX * sumY) / (sumW * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / sumW;
    
    const nextX = n + 1;
    const prediction = slope * nextX + intercept;
    
    let variance = 0;
    for (let i = 0; i < n; i++) {
        const x = i + 1;
        const y = data[i];
        const predicted = slope * x + intercept;
        variance += Math.pow(y - predicted, 2) * weights[i];
    }
    
    const stdError = Math.sqrt(variance / (n - 2));
    const margin = 1.96 * stdError * Math.sqrt(1 + 1/n);
    
    const confidence = Math.max(0, 100 - (stdError / (Math.max(...data) || 1)) * 150);
    
    return {
        prediction: Math.round(prediction),
        interval: [Math.round(prediction - margin), Math.round(prediction + margin)],
        confidence: Math.round(confidence)
    };
}

function adaptivePrediction(data) {
    if (data.length < 2) return { prediction: 0, signal: "НЕТ ДАННЫХ", confidence: 0 };
    
    const trends = [];
    for (let i = 1; i < data.length; i++) {
        trends.push(data[i] - data[i-1]);
    }
    
    const avgTrend = trends.reduce((a, b) => a + b, 0) / trends.length;
    const volatility = Math.sqrt(trends.reduce((a, b) => a + Math.pow(b - avgTrend, 2), 0) / trends.length);
    
    let prediction;
    let signal;
    
    if (volatility < 5) {
        prediction = data.reduce((a, b) => a + b, 0) / data.length;
        signal = "СТАБИЛЬНО";
    } else if (Math.abs(avgTrend) > 8) {
        prediction = data[data.length - 1] + avgTrend;
        signal = avgTrend > 0 ? "📈 РОСТ" : "📉 ПАДЕНИЕ";
    } else {
        const weights = data.map((_, i) => i + 1);
        const weightedSum = data.reduce((sum, val, i) => sum + val * weights[i], 0);
        prediction = weightedSum / weights.reduce((a, b) => a + b, 0);
        signal = "⏸️ ФЛЭТ";
    }
    
    const confidence = Math.max(0, 100 - volatility * 3);
    
    return {
        prediction: Math.round(prediction),
        signal: signal,
        confidence: Math.round(confidence)
    };
}

function calculateRiskLevel(data) {
    if (data.length < 2) return { level: "medium", text: "Недостаточно данных", icon: "⚠️" };
    
    const volatility = Math.sqrt(
        data.slice(1).reduce((sum, val, i) => sum + Math.pow(val - data[i], 2), 0) / (data.length - 1)
    );
    
    const avgValue = data.reduce((a, b) => a + b, 0) / data.length;
    const cv = (volatility / avgValue) * 100;
    
    if (cv < 15) return { level: "low", text: "Низкий риск", icon: "✅" };
    if (cv < 30) return { level: "medium", text: "Умеренный риск", icon: "⚠️" };
    return { level: "high", text: "Высокий риск", icon: "🚨" };
}

// Визуализация и обновление данных
function updateVisualization() {
    const svg = document.querySelector('.triangle-svg');
    svg.innerHTML = '';
    
    const team1p1 = parseInt(document.getElementById('team1-period1').value) || 0;
    const team2p1 = parseInt(document.getElementById('team2-period1').value) || 0;
    const team1p2 = parseInt(document.getElementById('team1-period2').value) || 0;
    const team2p2 = parseInt(document.getElementById('team2-period2').value) || 0;
    const team1p3 = parseInt(document.getElementById('team1-period3').value) || 0;
    const team2p3 = parseInt(document.getElementById('team2-period3').value) || 0;
    
    const totalFirstPeriod = team1p1 + team2p1;
    const totalSecondPeriod = team1p2 + team2p2;
    const totalThirdPeriod = team1p3 + team2p3;
    
    const periodData = [totalFirstPeriod, totalSecondPeriod];
    if (currentMode === 'three') periodData.push(totalThirdPeriod);
    
    let mainTotal, additionalTotal;
    if (currentMode === 'two') {
        mainTotal = (totalFirstPeriod + totalSecondPeriod) * 2;
        if (totalFirstPeriod > totalSecondPeriod) {
            mainTotal += (totalFirstPeriod - totalSecondPeriod);
        } else {
            mainTotal -= (totalSecondPeriod - totalFirstPeriod);
        }
        additionalTotal = null;
    } else {
        mainTotal = (totalFirstPeriod + totalSecondPeriod + totalThirdPeriod) * (4/3);
        if (totalThirdPeriod > totalSecondPeriod) {
            mainTotal += (totalThirdPeriod - totalSecondPeriod);
        } else {
            mainTotal -= (totalSecondPeriod - totalThirdPeriod);
        }
        mainTotal = Math.round(mainTotal);
        
        const twoPeriodTotal = (totalFirstPeriod + totalSecondPeriod) * 2;
        const diffTwoPeriods = Math.abs(totalFirstPeriod - totalSecondPeriod);
        let adjustedTwoPeriodTotal = twoPeriodTotal;
        if (totalFirstPeriod > totalSecondPeriod) {
            adjustedTwoPeriodTotal += diffTwoPeriods;
        } else {
            adjustedTwoPeriodTotal -= diffTwoPeriods;
        }
        additionalTotal = Math.round((mainTotal + adjustedTwoPeriodTotal) / 2);
    }
    
    // Прогнозирование
    const expSmooth = exponentialSmoothing(periodData);
    const wReg = weightedRegression(periodData);
    const adaptive = adaptivePrediction(periodData);
    const risk = calculateRiskLevel(periodData);
    
    // Обновление UI
    document.getElementById('expSmoothPrediction').textContent = expSmooth.prediction;
    document.getElementById('expSmoothAccuracy').textContent = expSmooth.accuracy + '%';
    document.getElementById('expSmoothConfidence').style.width = expSmooth.accuracy + '%';
    
    document.getElementById('weightedRegPrediction').textContent = wReg.prediction;
    document.getElementById('weightedRegInterval').textContent = wReg.interval[0] + ' - ' + wReg.interval[1];
    document.getElementById('weightedRegConfidence').style.width = wReg.confidence + '%';
    
    document.getElementById('adaptivePrediction').textContent = adaptive.prediction;
    document.getElementById('adaptiveSignal').textContent = adaptive.signal;
    document.getElementById('adaptiveConfidence').style.width = adaptive.confidence + '%';
    
    const riskIndicator = document.getElementById('riskIndicator');
    riskIndicator.className = 'risk-indicator risk-' + risk.level;
    document.getElementById('riskIcon').textContent = risk.icon;
    document.getElementById('riskText').textContent = risk.text;
    
    // Визуализация треугольника
    const points = [];
    if (currentMode === 'two') {
        points.push({x: 50, y: 250, value: totalFirstPeriod, label: 'Период 1'});
        points.push({x: 150, y: 50, value: totalSecondPeriod, label: 'Период 2'});
        points.push({x: 250, y: 250, value: mainTotal, label: 'Тотал'});
    } else {
        points.push({x: 50, y: 250, value: totalFirstPeriod, label: 'Период 1'});
        points.push({x: 150, y: 50, value: totalSecondPeriod, label: 'Период 2'});
        points.push({x: 250, y: 250, value: totalThirdPeriod, label: 'Период 3'});
        if (additionalTotal !== null) {
            points.push({x: 150, y: 150, value: additionalTotal, label: 'Доп. расчет'});
        }
    }
    
    if (points.length >= 3) {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        let pathData = `M ${points[0].x} ${points[0].y} `;
        for (let i = 1; i < points.length; i++) {
            pathData += `L ${points[i].x} ${points[i].y} `;
        }
        pathData += 'Z';
        path.setAttribute('d', pathData);
        path.setAttribute('fill', 'rgba(76, 201, 240, 0.2)');
        path.setAttribute('stroke', 'var(--primary)');
        path.setAttribute('stroke-width', '2');
        svg.appendChild(path);
    }
    
    points.forEach(point => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', point.x);
        circle.setAttribute('cy', point.y);
        circle.setAttribute('r', '6');
        circle.setAttribute('fill', 'var(--primary)');
        circle.setAttribute('stroke', 'white');
        circle.setAttribute('stroke-width', '2');
        svg.appendChild(circle);
        
        const textValue = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        textValue.setAttribute('x', point.x);
        textValue.setAttribute('y', point.y - 12);
        textValue.setAttribute('text-anchor', 'middle');
        textValue.setAttribute('fill', 'white');
        textValue.setAttribute('font-size', '10');
        textValue.setAttribute('font-weight', 'bold');
        textValue.textContent = point.value;
        svg.appendChild(textValue);
        
        const textLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        textLabel.setAttribute('x', point.x);
        textLabel.setAttribute('y', point.y + 20);
        textLabel.setAttribute('text-anchor', 'middle');
        textLabel.setAttribute('fill', 'var(--secondary)');
        textLabel.setAttribute('font-size', '8');
        textLabel.textContent = point.label;
        svg.appendChild(textLabel);
    });
    
    let trendIcon, trendText, trendClass;
    if (periodData.length >= 2) {
        const lastTrend = periodData[periodData.length - 1] - periodData[periodData.length - 2];
        if (lastTrend > 5) {
            trendIcon = '↗️';
            trendText = 'Сильный рост';
            trendClass = 'trend-up';
        } else if (lastTrend > 0) {
            trendIcon = '↗️';
            trendText = 'Умеренный рост';
            trendClass = 'trend-up';
        } else if (lastTrend < -5) {
            trendIcon = '↘️';
            trendText = 'Сильное падение';
            trendClass = 'trend-down';
        } else if (lastTrend < 0) {
            trendIcon = '↘️';
            trendText = 'Умеренное падение';
            trendClass = 'trend-down';
        } else {
            trendIcon = '↔️';
            trendText = 'Стабильность';
            trendClass = 'trend-stable';
        }
    } else {
        trendIcon = '↔️';
        trendText = 'Недостаточно данных';
        trendClass = 'trend-stable';
    }
    
    document.getElementById('trendIcon').textContent = trendIcon;
    document.getElementById('trendText').textContent = trendText;
    const trendIndicator = document.getElementById('trendIndicator');
    trendIndicator.classList.remove('trend-up', 'trend-down', 'trend-stable');
    trendIndicator.classList.add(trendClass);
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('selectedTheme') || 'sun';
    setTheme(savedTheme);
    document.querySelector(`[onclick="setTheme('${savedTheme}')"]`).classList.add('active');
});
</script>
</body>
</html>
